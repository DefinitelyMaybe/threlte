---
{
  order: 3,
  category: '@threlte/extras',
  sourcePath: 'packages/extras/src/lib/components/InstancedSprite/InstancedSprite.svelte',
  name: <InstancedSprite>,
  type: 'component',
  componentSignature:
    {
      props:
        [
          {
            name: 'fps',
            type: 'boolean',
            required: false,
            default: '10',
            description: 'The desired frames per second of the animation.'
          }
        ],
      events:
        [
          {
            name: 'load',
            payload: 'void',
            description: 'Fires when all resources have loaded.'
          }
        ],
      bindings:
        [
          { name: ref, type: 'Mesh' }
        ]
    }
}
---

<Tip type="experimental">Experimental warning. The api may change significantly, performance and compatiblity untested on various hardware/OS.</Tip>

<Example path="extras/instanced-sprite" />

## Usage

### Basic example
### Props

## Spritesheet

Spritesheet declaration, two modes:
- `rowColumn` where `w` is number of columns and `h` number of rows
- `frameSize` where `w` is width and `h` is height of a **single frame in the spritesheet**

{/* I'll center it later, don't yell at me */}
Preview of row and column numbering (orange, outside) and frame numbering (blue, inside)
![Spritesheet row-column](/images/docs/extras/instanced-sprite/spritesheet-rowcol.png)

Animations are declared as a range of frameIds, for example the `attack` animation of the spritesheet above would look like this:
```svelte
<Spritesheet
  let:File
  let:Animation
>
  <File
    textureUrl="/textures/sprites/cacodaemon.png"
    options={{
      type: 'rowColumn',
      w: 8,
      h: 4
    }}
  >
    <Animation
      name="attack"
      frameRange={[8, 14]}
    />
  </File>
</Spritesheet>
```

**One spritesheet file with multiple animations**
<details>
	<summary>Preview sprite</summary>
	*cacodaemon.png*
	![Multi image spritesheet](/textures/sprites/cacodaemon.png)
</details>

```svelte
<Spritesheet
  let:File
  let:Animation
>
  <File
    textureUrl="/textures/sprites/cacodaemon.png"
    options={{
      type: 'rowColumn',
      w: 8,
      h: 4
    }}
  >
    <Animation
      name="fly"
      frameRange={[0, 6]}
    />
    <Animation
      name="attack"
      frameRange={[8, 14]}
    />
    <Animation
      name="idle"
      frameRange={[16, 20]}
    />
    <Animation
      name="defeated"
      frameRange={[24, 32]}
    />
  </File>

  <InstancedSprite/>
</Spritesheet>

```

**Combining multiple files with one animation per file**
<details>
	<summary>Preview sprites</summary>
	*Attack.png*
	![Goblin Attack sprite](/textures/sprites/goblin/Attack.png)
	*Idle.png*
	![Goblin Idle sprite](/textures/sprites/goblin/Idle.png)
	*Run.png*
	![Goblin Run sprite](/textures/sprites/goblin/Run.png)
	*TakeHit.png*
	![Goblin TakeHit sprite](/textures/sprites/goblin/TakeHit.png)
</details>


```svelte
<Spritesheet
  let:File
  let:Animation
>
  <File
    textureUrl="/textures/sprites/goblin/Attack.png"
    options={{
      type: 'rowColumn',
      w: 8,
      h: 1
    }}
  >
    <Animation
      name="attack"
      frameRange={[0, 8]}
    />
  </File>

  <File
    textureUrl="/textures/sprites/goblin/Death.png"
    options={{
      type: 'rowColumn',
      w: 4,
      h: 1
    }}
  >
    <Animation
      name="death"
      frameRange={[0, 4]}
    />
  </File>
  <File
    textureUrl="/textures/sprites/goblin/Idle.png"
    options={{
      type: 'rowColumn',
      w: 4,
      h: 1
    }}
  >
    <Animation
      name="idle"
      frameRange={[0, 4]}
    />
  </File>

  <File
    textureUrl="/textures/sprites/goblin/Run.png"
    options={{
      type: 'rowColumn',
      w: 8,
      h: 1
    }}
  >
    <Animation
      name="run"
      frameRange={[0, 4]}
    />
  </File>

  <File
    textureUrl="/textures/sprites/goblin/TakeHit.png"
    options={{
      type: 'rowColumn',
      w: 4,
      h: 1
    }}
  >
    <Animation
      name="takeHit"
      frameRange={[0, 4]}
    />
  </File>

  <InstancedSprite/>
</Spritesheet>
```



### `<Spritesheet/>`
### `createSpritesheet()`
### Reusing spritesheet

## Updating instances

### `<Instance>`
### `context`

## Static sprites

This component focuses on targetting animated sprites, but it's possible to use it for static images as well.
If each frame of the spritesheet is a separate animation, then it effectively acts as an atlas with named sprites.

The `<Tree/>` component in the example above does this.
![Tree sprite atlas](/textures/sprites/trees-pixelart.png)

Set `autoUpdate={false}` on static components and only update it manually with `sprite.update()`. This has to be done when the InstancedSprite is initiated or when spritesheet or atlas change.
If you don't do it, then the spritesheet will run animation updates each frame to run animations that don't really exist.


## Advanced
### How it works
GPGPU, Data texture for user commands

### Triangle vs quad
Triangle vs Plane mode - triangle saves vertices but a larger area of the geometry is unused. Fragment discards, z sorting tradeoffs?

### Spritesheet format

```ts
type SpritesheetFormat = {
  frames: [x: number, y: number, w: number, h: number][];
  animations: Record<string, [frameId: number, duration: number][]>;
  sheetSize: [w: number, h: number][];
  animationLengths: number[];
};
```
